---
title: "GEM500: Markov Models"
author: "Jen Baron | University of British Columbia, Department of Forest and Conservation Sciences  jenbaron@mail.ubc.ca"
date: "October 4, 2021"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

This lab is an adaptation in R of Exercise 3 in Urban, D. L & Wallin O. W. Chapter 8: Introduction to Markov Models in Learning Landscape Ecology (2nd Ed.) (2017).

# Introduction

Much debate over the management of Pacific Northwestern (PNW) forests occurred in the early 1990s. The debate centered on the effects of intensive logging on old-growth forests and on old-growth-dependent wildlife species such as the northern spotted owl (Strix occidentalis) and the marbled murrelet (Brachyramphus marmoratus) (Hansen et al. 1991; Ruggiero et al. 1991), primarily on U.S. Forest Service land. Since most of the old-growth on private lands was already gone, most of the old-growth harvested in the 1980s came from these federal lands (Harris 1984; Robbins 1988). By the mid-1990s, harvests were reduced by over 90% on federal lands relative to the peak harvests of the late 1980s (FEMAT 1993; USDA Forest Service and USDI Bureau of Land Management 1994; Marcot and Thomas 1997).

*A central question during this debate was, how long can current rates of harvest be sustained before the old growth is virtually gone?*

**Study Area:** The Oregon Cascades were at the center of this debate over the management of PNW forests. The study area is on federally managed lands where timber harvesting has been conducted using a dispersed (staggered setting) system of 10-20 ha clear-cut patches. The rate and pattern of these disturbances is somewhat different than those on private lands (Spies et al. 1994) and is quite different than disturbances generated by wildfire during the presettlement era (Wallin et al. 1996b). Spatial data for this area were derived from Landsat Thematic Mapper data using methods outlined in Cohen et al. (1995, 1998, 2002) and Wallin et al. (1996a). Forest cover was classified into six approximate age classes (Table 8.1). The file samp200.gif shows 200 random locations on the 1972 image. The cover type at each of these locations was tallied at time 1 (1972), 2 (1984), and 3 (1991) on the three maps. This information is tallied in columns of a primary data matrix and is stored in sample200.csv.

In this exercise, you will build a simple model of landscape change, evaluate it, and use it as a point of departure to consider more realistic (but more complicated) models. Raster maps of Pacific Northwest forests are compared over three time periods to summarize the rates of transition between cover types. A simple model of landscape change is built from these transition probabilities. Lastly, this model is projected forward in time to verify and validate the model.

**Table 8.1** Definition of cover types in the Pacific Northwestern forest landscape.

| Class | Age (yr)   | Cover Type       |
|-------|------------|------------------|
| 0     | Background | (Non forest)     |
| 1     | 0-20       | Recent clear-cut |
| 2     | 21-40      | Early seral      |
| 3     | 41-80      | Mid seral        |
| 4     | 81-170     | Mature           |
| 5     | \>170      | Old growth       |

## Load Packages

```{r, message = FALSE}
library(here) 
here() #where is your working directory?
library(tidyr)
library(ggplot2)
library(dplyr)
library(raster)
library(ggpubr) #for combining plots
```

We're also going to use some functions stored in external R scripts which we need to call.

```{r}
source(here("rel.R")) # relativize by row sum
source(here("fix_tm.R")) # for annual time steps
```

## Load Data

This is the same data we used in part one to create our tally and probability matrix by-hand.

```{r}
pnw.data <- read.csv(here("sample200.csv"))

str(pnw.data)
head(pnw.data)
```

**Visualize Landscape**

```{r}
pnw72 <- raster("pnw72.gif")
pnw84 <- raster("pnw84.gif")
pnw91 <- raster("pnw91.gif")

plot(pnw72)
plot(pnw84)
plot(pnw91)
```

# Matrix Projection

Set initial conditions

```{r}
sample.n <- dim(pnw.data)[[1]] # number of rows in the dataset

#1972
t1972 <- table(as.factor(pnw.data$X1972)) # tally in each cover class
p1972 <- t1972/sample.n # proportion in each cover class

#1984
t1984 <- table(as.factor(pnw.data$X1984)) # tally in each cover class
p1984 <- t1984/sample.n  # proportion in each cover class

#1991
t1991 <- table(as.factor(pnw.data$X1991)) # tally in each cover class
p1991 <- t1991/sample.n # proportion in each cover class

inits <- as.vector(p1972) #initial time step
years <- c(1972, 1984, 1991)

pnw.d2 <- rbind(as.vector(p1972), as.vector(p1984), as.vector(p1991)) #combine initial conditions
pnw.d2 <- data.frame(cbind(years, pnw.d2)) #attach years

names(pnw.d2) <- c("Year","C1","C2","C3","C4","C5")

pnw.d2
```

Prepare the data to plot

```{r}
pnw.d2_long <- pnw.d2 %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion") #convert to "long" format to plot
head(pnw.d2_long)
```

Visualize the data

```{r}
ggplot(pnw.d2_long, aes(x=Year, y=Proportion, col = Class)) +
  geom_line() +
  geom_point() +
  theme_classic()
```

**Q1 What can you say about the current trajectory of landscape change? How is the 1972-1984 timestep different from the 1984-1991 timestep?**

## Transition Matrix

One way to summarize landscape change is to simply tally all the instances, on a cell-by-cell basis, in which a cell changed cover types over that time interval.

A concise way of summarizing these tallies is a raw **tally matrix**, which for m cover types is an m x m matrix. The elements, $n_{ij}$, of the tally matrix tally the number of cells that changed from type $i$ to type $j$ over a time interval.

A raw tally matrix is often converted into proportions by dividing each of the elements by the row total to generate a **transition matrix** $P$. The elements, $p_{ij}$, of the transition matrix $P$ summarize the proportion of cells of each cover type that changed into each other cover type during that time interval. The diagonal elements of this matrix, $p_{ii}$, are the proportions of cells that did not change.

*1972-1984*

```{r}
#build the tally matrix
t.72.84 <- table(pnw.data$X1972,pnw.data$X1984)
t.72.84 

# transition matrix
#relativize by row sum 
tr.72.84 <- rel(t.72.84, byrow=TRUE, bycol=FALSE)

# this is for a 12-yr time step, but we need annual steps
P <- fix.steps(tr.72.84, 12) #specify number of years in time-step here

P %>% round(3)
```

*1984-1991*

```{r}
t.84.91 <- table(pnw.data$X1984,pnw.data$X1991)
t.84.91

tr.84.91 <- rel(t.84.91, byrow=TRUE, bycol=FALSE)
P.84.91 <- fix.steps(tr.84.91, 7) #7 years between time steps

P.84.91 %>% round(3)
```

## Markov Model

A first-order Markov model (Usher 1992) assumes that to predict the state of the system at time $t + 1$, one need only know the state of the system at time t. The heart of a Markov model is the transition matrix $P$, which summarizes the probability that a cell in cover type $i$ will change to cover type $j$ during a single timestep. The timestep is the interval over which the data were observed to change (i.e., the time interval of the two maps).

To explore a Markov model, it is initialized with a state vector and then projected for one or more timesteps. The vector of cover types produced at each iteration is the prediction of overall landscape composition for that timestep.

**Run Projection**

```{r}
ntypes <- length(inits) # 5 classes, in this case

# create some empty data frames for the output 
ntimes <- 999 #number of years in projection
t <- vector(length=ntimes)
transient <- matrix(nrow=ntimes, ncol=ntypes)
```

```{r}
t[1] <- 1972
transient[1,] -> tmp
tmp <- inits # copy these to simplify the projections
t1 <- 1972

# the actual projection:
for (i in 1:ntimes) {
	t[i]<-t1+i
	transient[i,]<-tmp %*% P # matrix multiplication in R lingo
	tmp<-transient[i,]
}
```

```{r}
# add the "date" column for convenience:
out <- data.frame(cbind(t, transient)) 

# create labels for the output columns:
names(out)<-c("Year",paste("C",as.character(1:ntypes),sep=""))
```

**Validate**

Prepare the data to plot

```{r}
out_long <- out %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion") #convert to "long" format to plot
head(out_long)
```

Plot the output, first for just the initial few years

```{r}
p.V1 <- ggplot() +
  geom_line(data=out_long, aes(x=Year, y=Proportion, col = Class)) +
  xlim(1972,1995) +
  ylim(0,0.5) +
  theme_classic()
p.V1
```

Put the actual data on top of the model projections

```{r}
p.V1 +
  geom_point(data=pnw.d2_long, aes(x=Year, y=Proportion, col = Class)) +
  labs(title = "Model verification and validation") 
```

**Q2 How does the model perform compared to the data? Does this differ by timestep (1972-1984, 1984-1991)?**

**Visualize Projection**

Plot the entire simulation, so we can see the trend

```{r}
p.out <- ggplot() +
  geom_line(data=out_long, aes(x=Year, y=Proportion, col = Class)) +
  labs(title = "Baseline case, projected 1000 yr") +
  theme_classic()
p.out
```

**Q3 What changes does you observe in this projection? How do the initial conditions compare to the final conditions? Which classes change the most in terms of their proportional abundance?**

# Alternate Management Scenarios

## Adjust Harvest Rates (1/2)

**Change Rates**

Let's create an alternative management scenario by adjusting the harvest rate by half.

We need to adjust the probabilities between recent clear cut (1) and mature (4), and recent clear cut (1) and old growth (5).

```{r}
P2 <- P #start with the same probabilities as before

#change rate of conversion between clear-cut and mature
h41 <- P[4,1]/2 #half of current rate
P2[4,1] <- h41 #decrease the probability of harvest
P2[4,4] <- P[4,4]+h41 #increase the probability of retention

#change rate of conversion between clear-cut and old growth
h51 <- P[5,1]/2 #half of current rate
P2[5,1] <- h51 #decrease the probability of harvest
P2[5,5] <- P2[5,5]+h51 #increase the probability of retention

#Compare probabilities before and after:
P %>% round(3)
P2 %>% round(3)
```

**Run Projection**

```{r}
trans2 <- matrix(nrow=ntimes, ncol=ntypes) #transition matrix
t1<-1972
trans2[1,]<-inits
tmp<-inits

# the projection:
for (i in 1:ntimes) {
	t[i]<-t1+i
	trans2[i,]<-tmp %*% P2 # matrix multiplication in R lingo
	tmp<-trans2[i,]
}
out2 <- data.frame(cbind(t, trans2))
out2<- rbind(c(t1,inits),out2)

names(out2)<-c("Year",paste("C",as.character(1:ntypes),sep=""))
```

**Visualize Projection**

```{r}
out_long2 <- out2 %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion") #convert to "long" format to plot
head(out_long2)
```

```{r}
p.out2 <- ggplot() +
  geom_line(data=out_long2, aes(x=Year, y=Proportion, col = Class)) +
  labs(title = "Projection under 1/2 harvesting rate") +
  theme_classic()
p.out2
```

## Adjust Harvest Rates (1/4)

**Change Rates**

```{r}
P3 <- P2 #start with the same probabilities as before

#change rate of conversion between clear-cut and mature
h41.2 <- P2[4,1]/2 #half the current rate
P3[4,1] <- h41.2 #decrease the probability of harvest
P3[4,4] <- P3[4,4]+h41.2 #increase the probability of retention

#change rate of conversion between clear-cut and old growth
h51.2 <- P2[5,1]/2 #half the current rate
P3[5,1] <- h51.2 #decrease the probability of harvest
P3[5,5] <- P3[5,5]+h51.2 #increase the probability of retention


#Compare probabilities before and after:
P %>% round(3)
P2 %>% round(3)
P3 %>% round(3)
```

**Q4 What is the probability that mature (4) and old-growth (5) forests will be clear cut under i) 1972-1984 harvest rates ii) 1/2 the harvest rate iii) 1/4 the harvest rate?**

**Run Projection**

```{r}
trans3 <- matrix(nrow=ntimes, ncol=ntypes)
t1<-1972
trans3[1,]<-inits
tmp<-inits
# the projection:
for (i in 1:ntimes) {
	t[i]<-t1+i
	trans3[i,]<-tmp %*% P3 # matric multiplication in R lingo
	tmp<-trans3[i,]
}
out3 <- data.frame(cbind(t, trans3))
out3 <- rbind(c(t1,inits),out3)
names(out3)<-c("Year",paste("C",as.character(1:ntypes),sep=""))

```

**Visualize Projection**

```{r}
out_long3 <- out3 %>% 
  pivot_longer(cols=starts_with("C"), 
               names_to="Class", 
               values_to="Proportion") #convert to "long" format to plot
head(out_long3)
```

```{r}
p.out3 <- ggplot() +
  geom_line(data=out_long3, aes(x=Year, y=Proportion, col = Class)) +
  labs(title = "Projection under 1/4th harvesting rate") +
  theme_classic()
p.out3
```

## Compare Projections

```{r, fig.width=4, fig.height=8}
ggarrange(p.out, p.out2, p.out3, 
          nrow=3)
```

**Q5 Describe how the different management scenarios produce different outcomes in terms of landscape composition.**

Look more closely at old growth sustainability

```{r}
ggplot() +
  geom_line(data=out, aes(x=Year, y=C5, col = "a"), size=0.8) +
  geom_line(data=out2, aes(x=Year, y=C5, col = "b"), size=0.8) +
  geom_line(data=out3, aes(x=Year, y=C5, col = "c"), size=0.8) +
  scale_colour_manual(name = 'Harvesting Rate', #force legend
         values=c('a'='black','b'='saddlebrown','c'='darkgreen'), 
         labels = c("1972-84 rate","50% rate","25% rate")) +
  ylim(0.1,0.5) +
  scale_x_continuous(limits = c(1970,2100),n.breaks=8) +
  labs("Old growth sustainability?", y = "Proportion Old Growth") +
  theme_classic()
```

**Q6 Are the 1982-1984 rates of harvest sustainable for old-growth forests?**

**Q7 How does this modelling structure support and/or constrain your ability to ask research questions relevant to this landscape?**


**Q8 What scenarios could be applied to incorporate more complex and realistic mechanisms of landscape change? How could these scenarios be incorporated into the model?**


# Additional Modelling Scenarios

## 1. Modify Harvest Rate

Modify the harvest rate to investigate one of these alternative management scenarios:

a.   Increase initial harvest rate by 1/2
b.   Decrease harvest to 1/8 initial rate

```{r}

```

## 2. Project (1984-1991 baseline)

Run the Markov model using the 1984-1991 data instead of the 1972-1984 data and compare the projections.

```{r}

```

## 3. Design Your Own Scenario

Design a management scenario that would modify the transition matrix and alter future landscapes.

```{r}

```

# Save Outputs

Export the model outputs.

```{r}
write.csv(out,"markov_out.csv")
write.csv(out2, "markov_out_half.csv")
write.csv(out3, "markov_out_quarter.csv")
```

# Conclusions

This concludes the development, verification, and validation of a simple Markov model of landscape change. In some applications, such a simple model is sufficient (e.g., Johnson and Sharpe 1976; Johnson 1977; Hall et al. 1991). But in many cases, this simple model serves as a point of departure for more complicated models (e.g., Turner 1987; Baker 1989; Acevedo et al. 1995, 1996; Wear and Bolstad 1998; Wu and Webster 1998; Hong and Mladenoff 1999a, b; Mladenoff and Baker 1999; Urban et al. 1999). In particular, some consideration of the assumptions and limitations of Markov models can be a useful aid in interpreting the behavior and predictions of other models (see Ch8 Further Considerations in Modeling Landscape Change).

**Acknowledgements**

The classified imagery used in this lab was developed under funding provided by the USDA Forest Service New Perspectives Program, the National Sciences Foundation through the H.J. Andrews Long-Term Ecological Research (LTER) site (Grant 90-11663) and the Terrestrial Ecology Program of the National Aeronautics and Space Administration (NAGW-3745).

# Session Details

This code tells us when we ran our analysis, under what operating system, and what packages we used, making it easier for our colleagues to reproduce it.

```{r}
Sys.time()
sessionInfo()
```
